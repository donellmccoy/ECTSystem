name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0'
      - name: Restore dependencies
        run: dotnet restore ECTSystem.sln
      - name: Build
        run: dotnet build --configuration Release --no-restore
      - name: Publish AppHost
        run: dotnet publish AF.ECT.AppHost/AF.ECT.AppHost.csproj --configuration Release --output ./publish/apphost
      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: apphost
          path: ./publish/apphost

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0'
      - name: Restore dependencies
        run: dotnet restore ECTSystem.sln
      - name: Run tests
        run: dotnet test AF.ECT.Tests/AF.ECT.Tests.csproj --configuration Release --collect "XPlat Code Coverage" --results-directory ./test-results
      - name: Upload test results
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: ./test-results